<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ëŒ€íšŒ í˜„ì¬ ë“±ìˆ˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 16px;
      background: #f5f5f5;
    }
    h1 {
      text-align: center;
      margin-bottom: 16px;
    }
    .updated {
      text-align: right;
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #ffffff;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      text-align: center;
      font-size: 14px;
    }
    th {
      background: #222;
      color: #fff;
    }
    tr:nth-child(even) td {
      background: #fafafa;
    }
    .name {
      text-align: left;
    }
    .small {
      font-size: 12px;
      color: #999;
    }
  </style>
</head>
<body>
  <h1>í˜„ì¬ ë“±ìˆ˜</h1>
  <div class="updated" id="updated">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  <table>
    <thead>
      <tr>
        <th>ìˆœìœ„</th>
        <th>ì´ë¦„</th>
        <th>ì´í•©</th>
        <th>1Â·2Â·3ìˆœ í•©</th>
      </tr>
    </thead>
    <tbody id="rank-body">
      <!-- JSë¡œ ì¤„ì´ ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </tbody>
  </table>
  <p class="small">â€» 10ì´ˆë§ˆë‹¤ ìë™ìœ¼ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•´ë„ ë©ë‹ˆë‹¤.</p>

  <script>
    // âœ… ì—¬ê¸°ë§Œ ë„¤ rank ì‹œíŠ¸ì˜ CSV ì£¼ì†Œë¡œ êµì²´í•˜ë©´ ë¨
    // ì˜ˆ: https://docs.google.com/spreadsheets/d/XXXX/export?format=csv&gid=YYYY
    const RANKINGS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTqsmOlxzgGxrh91wGE0b92x3x40Ta1ZT2l0yd6rTKq5HsrZSng3qocNXwmypouA5F6H68HV46GPVHJ/pub?gid=0&single=true&output=csv";

    async function loadRanking() {
      const updated = document.getElementById("updated");
      const tbody = document.getElementById("rank-body");

      try {
        const url =
          RANKINGS_CSV_URL +
          (RANKINGS_CSV_URL.includes("?") ? "&" : "?") +
          "cachebuster=" +
          Date.now();

        const res = await fetch(url);
        if (!res.ok) {
          throw new Error("HTTP ìƒíƒœì½”ë“œ: " + res.status);
        }

        const text = await res.text();

        // HTMLì´ ì˜¤ë©´ (ê¶Œí•œ ë¬¸ì œ ë“±) ë°”ë¡œ ì—ëŸ¬ ì²˜ë¦¬
        if (text.trim().startsWith("<")) {
          throw new Error("CSV ëŒ€ì‹  HTML ì‘ë‹µì´ ì™”ìŠµë‹ˆë‹¤. (ê³µìœ /ê¶Œí•œ ì„¤ì • í™•ì¸ í•„ìš”)");
        }

        const rows = text
          .trim()
          .split(/\r?\n/)
          .map(line => line.split(","));

        // rows[0] : 1í–‰(í° ì œëª©ë“¤)
        // rows[1] : 2í–‰(í—¤ë”: ì´ë¦„/ìˆœìœ„/ì´í•©/1ì‹œ/2ì‹œ/...)
        const dataRows = rows.slice(2);

        const items = dataRows
          .map(cols => {
            const name = (cols[1] ?? "").trim();      // Bì—´: ì´ë¦„
            if (!name) return null;

            const total = Number(cols[3] ?? 0);       // Dì—´: ì´í•©

            // 1ìˆœ ì‹œê°„ë³„ (E~I â†’ ì¸ë±ìŠ¤ 4~8)
            const firstRoundShots = [
              Number(cols[4] ?? 0),
              Number(cols[5] ?? 0),
              Number(cols[6] ?? 0),
              Number(cols[7] ?? 0),
              Number(cols[8] ?? 0),
            ];

            const firstRoundSum  = Number(cols[9]  ?? 0);  // Jì—´: 1ìˆœ í•©
            const secondRoundSum = Number(cols[15] ?? 0);  // Pì—´: 2ìˆœ í•©
            const thirdRoundSum  = Number(cols[21] ?? 0);  // Vì—´: 3ìˆœ í•©

            return {
              name,
              total,
              firstRoundSum,
              secondRoundSum,
              thirdRoundSum,
              firstRoundShots,
            };
          })
          .filter(item => item !== null);

        // ğŸ”¥ ìˆœìœ„ ì •ë ¬ ë¡œì§
        items.sort((a, b) => {
          // 1) ì´í•© ë†’ì€ ì‚¬ëŒ
          if (b.total !== a.total) {
            return b.total - a.total;
          }

          // 2) 1ìˆœ í•©, 2ìˆœ í•©, 3ìˆœ í•© ìˆœìœ¼ë¡œ ë¹„êµ
          if (b.firstRoundSum !== a.firstRoundSum) {
            return b.firstRoundSum - a.firstRoundSum;
          }
          if (b.secondRoundSum !== a.secondRoundSum) {
            return b.secondRoundSum - a.secondRoundSum;
          }
          if (b.thirdRoundSum !== a.thirdRoundSum) {
            return b.thirdRoundSum - a.thirdRoundSum;
          }

          // 3) 1ìˆœì—ì„œ ë¨¼ì € ë§ì¶˜ ì‚¬ëŒ (ì™¼ìª½ë¶€í„° ë¹„êµ)
          for (let i = 0; i < a.firstRoundShots.length; i++) {
            if (b.firstRoundShots[i] !== a.firstRoundShots[i]) {
              // ë” ë¹ ë¥¸ ì‹œê°„ì— ë§ì¶˜(ê°’ì´ 1ì¸) ì‚¬ëŒì´ ìš°ìœ„
              return b.firstRoundShots[i] - a.firstRoundShots[i];
            }
          }

          // ì™„ì „ ë™ë¥ ì´ë©´ ìˆœì„œ ìœ ì§€
          return 0;
        });

        tbody.innerHTML = "";
        items.forEach((item, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td class="name">${item.name}</td>
            <td>${item.total}</td>
            <td>${item.firstRoundSum} / ${item.secondRoundSum} / ${item.thirdRoundSum}</td>
          `;
          tbody.appendChild(tr);
        });

        const now = new Date();
        updated.textContent =
          "ë§ˆì§€ë§‰ ê°±ì‹ : " +
          now.toLocaleTimeString("ko-KR", { hour12: false });
      } catch (e) {
        console.error(e);
        updated.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message;
        tbody.innerHTML = "";
      }
    }

    loadRanking();
    setInterval(loadRanking, 10000);
  </script>
</body>
</html>